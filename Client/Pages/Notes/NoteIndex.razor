@*--------------------------------------------------------------------------
    **
    **  Copyright (c) 2020, Dale Sinder
    **
    **  Name: NoteIndex.razor
    **
    **  Description: Displays the main file index grid
    **     Base notes and expands to show responses
    **
    **  This program is free software: you can redistribute it and/or modify
    **  it under the terms of the GNU General Public License version 3 as
    **  published by the Free Software Foundation.
    **
    **  This program is distributed in the hope that it will be useful,
    **  but WITHOUT ANY WARRANTY; without even the implied warranty of
    **  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    **  GNU General Public License version 3 for more details.
    **
    **  You should have received a copy of the GNU General Public License
    **  version 3 along with this program in file "license-gpl-3.0.txt".
    **  If not, see <http: //www.gnu.org/licenses/gpl-3.0.txt>.
    **
    **--------------------------------------------------------------------------*@

@using Notes2021Blazor.Shared
@using Syncfusion.EJ2.Blazor.Grids
@using Syncfusion.EJ2.Blazor.Navigations
@using System.Timers

@if (@Model.myAccess.ReadAccess)
{
    @Message
    <div class="col-lg-12 control-section dialoglist">
        <div class="content-wrapper">
            <div class="row">
                <div style="z-index:50; min-width:100%;">
                    <ListMenu Model="@Model" OnClick="ClickHandler" />
                </div>
                <EjsGrid @ref="MyGrid" DataSource="@Model.Notes" AllowPaging="true" AllowSelection="true" EnableHover="true" Toolbar="Toolbaritems" AllowExcelExport="true" AllowPdfExport="true"  >
                    <GridPageSettings PageSize="Model.UserData.Ipref2" PageSizes="true"></GridPageSettings>
                    <GridEvents RowSelected="DisplayIt" OnToolbarClick="ToolbarClickHandler" TValue="NoteHeader"></GridEvents>
                    <GridTemplates>
                        <DetailTemplate>
                            @{
                                var current = (context as NoteHeader);
                                List<NoteHeader> Resp = Model.AllNotes.Where(p => p.NoteOrdinal == current.NoteOrdinal && p.ResponseOrdinal != 0).OrderBy(p => p.ResponseOrdinal).ToList();
                            }
                            <EjsGrid @ref="MyGrid2" DataSource="@Resp" AllowPaging="false" AllowSelection="true" EnableHover="true">
                                <GridEvents RowSelected="DisplayIt" TValue="NoteHeader"></GridEvents>
                                <GridColumns>
                                    <GridColumn Field=@nameof(NoteHeader.ResponseOrdinal) HeaderText="Resp. #" TextAlign="TextAlign.Left" Width="25" IsPrimaryKey="true"></GridColumn>
                                    <GridColumn Field=@nameof(NoteHeader.NoteSubject) HeaderText="Subject" TextAlign="TextAlign.Left" Width="150"></GridColumn>
                                    <GridColumn Field=@nameof(NoteHeader.AuthorName) HeaderText="Writer" TextAlign="TextAlign.Left" Width="80"></GridColumn>

                                    <GridColumn Field=@nameof(NoteHeader.CreateDate) HeaderText="Date/Time" TextAlign="TextAlign.Left" Width="60">
                                        <Template Context="inner">
                                            @{
                                                var itemx = (inner as NoteHeader);
                                                DateTime curTimex = Model.tZone.LocalBlazor(itemx.CreateDate);
                                                string tellx = curTimex.ToShortDateString() + " " + curTimex.ToShortTimeString() /*+ " " + Model.tZone.Abbreviation*/;
                                                <span>@tellx</span>
                                            }
                                        </Template>
                                    </GridColumn>

                                </GridColumns>
                            </EjsGrid>
                        </DetailTemplate>
                    </GridTemplates>
                    <GridColumns>
                        <GridColumn Field=@nameof(NoteHeader.NoteOrdinal) HeaderText="#" TextAlign="TextAlign.Left" Width="25" IsPrimaryKey="true"></GridColumn>
                        <GridColumn Field=@nameof(NoteHeader.NoteSubject) HeaderText="Subject" TextAlign="TextAlign.Left" Width="150"></GridColumn>
                        <GridColumn Field=@nameof(NoteHeader.AuthorName) HeaderText="Writer" TextAlign="TextAlign.Left" Width="80"></GridColumn>
                        <GridColumn HeaderText="Date/Time" TextAlign="TextAlign.Left" Width="60">
                            <Template>
                                @{
                                    var item = (context as NoteHeader);
                                    DateTime curTime = Model.tZone.LocalBlazor(item.CreateDate);
                                    string tell = curTime.ToShortDateString() + " " + curTime.ToShortTimeString() /*+ " " + Model.tZone.Abbreviation*/;
                                    <span>@tell</span>
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field=@nameof(NoteHeader.ResponseCount) HeaderText="Responses" TextAlign="TextAlign.Left" Width="40"></GridColumn>
                    </GridColumns>
                </EjsGrid>
            </div>
        </div>
    </div>
}
else if (@Model.myAccess.Write)
{
    <ListMenu Model="@Model" OnClick="ClickHandler" />
    <h3>You may not read this file, but you may write to it.</h3>
}
else
{
    <h3>You may not read this file.</h3>
}


@code{
    [Parameter] public NoteDisplayIndexModel Model { get; set; }
    [Parameter] public int FirstOrdinal { get; set; }
    [Parameter] public EventCallback<string> OnClick { get; set; }

    EjsGrid<NoteHeader> MyGrid;
    EjsGrid<NoteHeader> MyGrid2;

    private string Message { get; set; }

    private Timer timer { get; set; }

    private List<ItemModel> Toolbaritems = new List<ItemModel>();

    protected override void OnInitialized()
    {
        Toolbaritems.Add(new ItemModel() { Text = "Print" });
        Toolbaritems.Add(new ItemModel() { Text = "PdfExport" });
        Toolbaritems.Add(new ItemModel() { Text = "ExcelExport" });
        Toolbaritems.Add(new ItemModel() { Text = "Expand all" });
        Toolbaritems.Add(new ItemModel() { Text = "Collapse all", Align = (Syncfusion.EJ2.Blazor.Navigations.ItemAlign.Right) });
    }

    protected override void OnAfterRender(bool firstRender)
    {
        timer = new Timer(500);
        timer.Elapsed += TimerTick;
        timer.Enabled = true;
    }

    protected void TimerTick(Object source, ElapsedEventArgs e)
    {
        timer.Enabled = false;
        int pSize = MyGrid.PageSettings.PageSize;
        int page = (int)(((FirstOrdinal - 1) / pSize) + 1.98);
        if (page == MyGrid.PageSettings.CurrentPage)  // prevent infinite loop
            return;
        MyGrid.GoToPage(page);
    }

    protected void DisplayIt(RowSelectEventArgs<NoteHeader> args)
    {
        OnClick.InvokeAsync("Note:" + args.Data.Id);
    }

    protected void ClickHandler(string message)
    {
        OnClick.InvokeAsync(message);
    }

    public void ToolbarClickHandler(Syncfusion.EJ2.Blazor.Navigations.ClickEventArgs args)
    {
        Message = args.Item.Id;
        if (args.Item.Text == "Expand all")
        {
            this.MyGrid.DetailExpandAll();
        }
        if (args.Item.Text == "Collapse all")
        {
            this.MyGrid.DetailCollapseAll();
        }
        if (args.Item.Id.EndsWith("_pdfexport"))
        {
            PdfExportProperties ExportProperties = new PdfExportProperties();
            ExportProperties.FileName = /*Model.noteFile.NoteFileName +*/ "pad.pdf";
            //pdfp.HierarchyExportMode = HierarchyGridPrintMode.Expanded;
            //pdfp.PageOrientation = PageOrientation.Landscape;
            this.MyGrid.PdfExport();
        }
        if (args.Item.Id.EndsWith("_excelexport"))
        {
            this.MyGrid.ExcelExport();
        }
        Message = null;
    }

}
